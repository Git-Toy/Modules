// BSLLS:MissingTemporaryFileDeletion-off

#Область ОписаниеПеременных

// Хранит имя временного файла на сервере для его последующего удаления
&НаКлиенте
Перем ИмяФайлаОбработкиНаСервере;

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ЗагрузитьНоменклатуруИзКупца(Команда)
	
	Если НЕ ПроверитьЗаполнение() Тогда
		Возврат;
	КонецЕсли;
	
	ИмяФайлаОбработкиНаКлиенте = ПолучитьИмяОбработки();
	ОписаниеОповещения = Новый ОписаниеОповещения("ПослеЗагрузкиОбработкиНаСервер", ЭтотОбъект);
	НачатьПомещениеФайла(ОписаниеОповещения, , ИмяФайлаОбработкиНаКлиенте, Ложь, УникальныйИдентификатор);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Функция ПолучитьИмяОбработки()
	
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	ИмяФайлаОбработки = ОбработкаОбъект.ИспользуемоеИмяФайла;
	Возврат ИмяФайлаОбработки;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьИмяВременногоФайлаНаСервере(Расширение)
	
	Возврат ПолучитьИмяВременногоФайла(Расширение);
	
КонецФункции

&НаСервереБезКонтекста
Процедура УдалитьФайлНаСервере(Знач ИмяФайла)
	
	УдалитьФайлы(ИмяФайла);
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗагрузкиОбработкиНаСервер(Результат, Адрес, ВыбранноеИмяФайла, ДополнительныеПараметры) Экспорт
	
	ПараметрыМетода = Новый Структура;
	ПараметрыМетода.Вставить("ИсточникДанных", ИсточникДанных);
	ПараметрыМетода.Вставить("Пользователь", Пользователь);
	ПараметрыМетода.Вставить("Пароль", Пароль);
	
	НаименованиеЗадания = НСтр("ru = 'Обработка данных'");
	
	ВыполнитьМетодВФоне(
		"ЗагрузитьНоменклатуруИзКупца",
		НаименованиеЗадания,
		Адрес,
		ПараметрыМетода);
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеФоновойОбработкиДанных(Задание, ДополнительныеПараметры) Экспорт
	
	Если Задание <> Неопределено Тогда
		Если Задание.Статус = "Ошибка" Тогда
			ТекстОшибки = Задание.ПодробноеПредставлениеОшибки;
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
		КонецЕсли;
		
		УдалитьФайлНаСервере(ИмяФайлаОбработкиНаСервере);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ВыполнитьМетодВФонеНаСервере(Знач ИмяМетода, Знач Адрес, Знач ИмяФайлаОбработки, Знач ПараметрыМетода)
	
	Если ЗначениеЗаполнено(ИдентификаторЗадания) Тогда
		Попытка
			ЗаданиеВыполнено = ДлительныеОперации.ЗаданиеВыполнено(ИдентификаторЗадания);
		Исключение
			ЗаданиеВыполнено = Истина;
		КонецПопытки;
	Иначе
		ЗаданиеВыполнено = Истина;
	КонецЕсли;
	
	Если НЕ ЗаданиеВыполнено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ВыполняемыйМетод = "ДлительныеОперации.ВыполнитьПроцедуруМодуляОбъектаОбработки";
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ИдентификаторФормы", ЭтаФорма.УникальныйИдентификатор);
	СтруктураПараметров.Вставить("ИмяФормы", ЭтаФорма.ИмяФормы);
	
	Если ТипЗнч(ПараметрыМетода) = Тип("Структура") Тогда
		Для Каждого ПараметрМетода Из ПараметрыМетода Цикл
			СтруктураПараметров.Вставить(ПараметрМетода.Ключ, ПараметрМетода.Значение);
		КонецЦикла;
	КонецЕсли;
	
	Данные = ПолучитьИзВременногоХранилища(Адрес);
	Данные.Записать(ИмяФайлаОбработки);
	
	ИмяФайлаОбработки = ПолучитьИмяОбработки(); // Отладка!!
	
	ПараметрыЗадания = Новый Структура;
	ПараметрыЗадания.Вставить("ИмяМетода", ИмяМетода);
	ПараметрыЗадания.Вставить("ИмяОбработки", ИмяФайлаОбработки);
	ПараметрыЗадания.Вставить("ПараметрыВыполнения", СтруктураПараметров);
	ПараметрыЗадания.Вставить("ЭтоВнешняяОбработка", Истина);
	
	ПараметрыВыполнения = ДлительныеОперации.ПараметрыВыполненияВФоне(ЭтаФорма.УникальныйИдентификатор);
	ПараметрыВыполнения.ЗапуститьВФоне = Истина;
	
	РезультатФоновогоЗадания = ДлительныеОперации.ВыполнитьВФоне(ВыполняемыйМетод, ПараметрыЗадания, ПараметрыВыполнения);
	ИдентификаторЗадания = РезультатФоновогоЗадания.ИдентификаторЗадания;
	
	Возврат РезультатФоновогоЗадания;
	
КонецФункции

&НаКлиенте
Процедура ВыполнитьМетодВФоне(ИмяМетода, НаименованиеЗадания, Адрес, ПараметрыМетода = Неопределено)
	
	ИмяФайлаОбработкиНаСервере = ПолучитьИмяВременногоФайлаНаСервере("epf");
	Задание = ВыполнитьМетодВФонеНаСервере(ИмяМетода, Адрес, ИмяФайлаОбработкиНаСервере, ПараметрыМетода);
	
	Если Задание <> Неопределено Тогда
		ОповещениеОЗавершении = Новый ОписаниеОповещения("ПослеФоновойОбработкиДанных", ЭтотОбъект);
		
		НастройкиОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(ЭтотОбъект);
		НастройкиОжидания.ТекстСообщения = НаименованиеЗадания;
		НастройкиОжидания.ВыводитьПрогрессВыполнения = Истина;
		НастройкиОжидания.ВыводитьСообщения = Истина;
		НастройкиОжидания.Интервал = 1;
		
		ДлительныеОперацииКлиент.ОжидатьЗавершение(Задание, ОповещениеОЗавершении, НастройкиОжидания);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти